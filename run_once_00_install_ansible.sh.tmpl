#!/bin/bash

set -euo pipefail

# Pre-flight check function for Ansible - Exit if Ansible is already installed
check_ansible_installed() {
    if command -v ansible &>/dev/null; then
        echo "[chezmoi] Ansible is already installed."
        exit 0
    fi
}

# Function to check if Ansible exists post-installation and its version - Exit with error if not found
check_ansible_version() {
    if command -v ansible &>/dev/null; then
        echo "[chezmoi] Ansible is installed successfully."
        ANSIBLE_VERSION=$(ansible --version | head -n1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        echo "[chezmoi] Ansible version: $ANSIBLE_VERSION"
    else
        echo "[chezmoi] Ansible did not install properly! Please check the installation logs."
        exit 1
    fi
}

# Function to install Ansible based on the OS
install_ansible() {
    {{ if eq .osid "darwin" }}
    echo "[chezmoi] Installing Ansible on macOS..."
    if ! command -v brew &>/dev/null; then
        echo "[chezmoi] Homebrew is not installed. Please install Homebrew first and re-run this Chezmoi setup."
        exit 1
    fi
    brew update
    if ! brew list python3 &>/dev/null; then
        echo "[chezmoi] python3 not found. Installing..."
        brew install python3 || true
    else
        echo "[chezmoi] python3 already installed via brew."
    fi
    if ! python3 -m pip show ansible &>/dev/null; then
        python3 -m pip install --user ansible
    else
        echo "[chezmoi] ansible already installed via pip."
    fi
    check_ansible_version

    {{ else if eq .osid "linux-arch" }}
    echo "[chezmoi] Installing Ansible on Arch Linux..."
    if ! pacman -Qi python &>/dev/null; then
        echo "[chezmoi] python not found. Installing..."
        sudo pacman -S --noconfirm --needed python || true
    else
        echo "[chezmoi] python already installed via pacman."
    fi
    if ! pacman -Qi python-pip &>/dev/null; then
        echo "[chezmoi] python-pip not found. Installing..."
        sudo pacman -S --noconfirm --needed python-pip || true
    else
        echo "[chezmoi] python-pip already installed via pacman."
    fi
    if ! python3 -m pip show ansible &>/dev/null; then
        python3 -m pip install --user ansible
    else
        echo "[chezmoi] ansible already installed via pip."
    fi
    check_ansible_version

    {{ else if eq .osid "linux-debian" }}
    echo "[chezmoi] Installing Ansible on Debian-based systems..."
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq > /dev/null
    if ! dpkg -s wget &>/dev/null; then
        echo "[chezmoi] wget not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install wget -y -qq > /dev/null
    else
        echo "[chezmoi] wget already installed."
    fi
    if ! dpkg -s gpg &>/dev/null; then
        echo "[chezmoi] gpg not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install gpg -y -qq > /dev/null
    else
        echo "[chezmoi] gpg already installed."
    fi
    DEBIAN_CODENAME=$(. /etc/os-release && echo $VERSION_CODENAME)
    wget -qO- "https://keyserver.ubuntu.com/pks/lookup?fingerprint=on&op=get&search=0x6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367" | sudo gpg --dearmour -o /usr/share/keyrings/ansible-archive-keyring.gpg
    echo "deb http://deb.debian.org/debian ${DEBIAN_CODENAME}-backports main" | sudo tee /etc/apt/sources.list.d/backports.list > /dev/null
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq > /dev/null
    if ! dpkg -s software-properties-common &>/dev/null; then
        echo "[chezmoi] software-properties-common not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install software-properties-common -y -qq > /dev/null
    else
        echo "[chezmoi] software-properties-common already installed."
    fi
    if ! dpkg -s python3 &>/dev/null; then
        echo "[chezmoi] python3 not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install python3 -y -qq > /dev/null
    else
        echo "[chezmoi] python3 already installed."
    fi
    if ! dpkg -s python3-pip &>/dev/null; then
        echo "[chezmoi] python3-pip not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install python3-pip -y -qq > /dev/null
    else
        echo "[chezmoi] python3-pip already installed."
    fi
    if ! python3 -m pip show ansible &>/dev/null; then
        python3 -m pip install --user ansible
    else
        echo "[chezmoi] ansible already installed via pip."
    fi
    check_ansible_version

    {{ else if eq .osid "linux-ubuntu" }}
    echo "[chezmoi] Installing Ansible on Ubuntu..."
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq > /dev/null
    if ! dpkg -s software-properties-common &>/dev/null; then
        echo "[chezmoi] software-properties-common not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install software-properties-common -y -qq > /dev/null
    else
        echo "[chezmoi] software-properties-common already installed."
    fi
    if ! dpkg -s python3 &>/dev/null; then
        echo "[chezmoi] python3 not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install python3 -y -qq > /dev/null
    else
        echo "[chezmoi] python3 already installed."
    fi
    if ! dpkg -s python3-pip &>/dev/null; then
        echo "[chezmoi] python3-pip not found. Installing..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install python3-pip -y -qq > /dev/null
    else
        echo "[chezmoi] python3-pip already installed."
    fi
    sudo DEBIAN_FRONTEND=noninteractive add-apt-repository -y -update ppa:ansible/ansible > /dev/null
    if ! python3 -m pip show ansible &>/dev/null; then
        python3 -m pip install --user ansible
    else
        echo "[chezmoi] ansible already installed via pip."
    fi
    check_ansible_version

    {{ else if eq .osid "linux-fedora" }}
    echo "[chezmoi] Installing Ansible on Fedora..."
    if ! dnf list installed python3 &>/dev/null; then
        echo "[chezmoi] python3 not found. Installing..."
        sudo dnf install -y python3 || true
    else
        echo "[chezmoi] python3 already installed via dnf."
    fi
    if ! dnf list installed python3-pip &>/dev/null; then
        echo "[chezmoi] python3-pip not found. Installing..."
        sudo dnf install -y python3-pip || true
    else
        echo "[chezmoi] python3-pip already installed via dnf."
    fi
    if ! python3 -m pip show ansible &>/dev/null; then
        python3 -m pip install --user ansible
    else
        echo "[chezmoi] ansible already installed via pip."
    fi
    check_ansible_version
    {{ end }}
}

echo "[chezmoi] Prewarming sudo..."
sudo true
echo "[chezmoi] Checking if Ansible is already installed..."
check_ansible_installed
echo "[chezmoi] Ansible not found! Proceeding with installation..."
echo "[chezmoi] This may take a while, please be patient..."
install_ansible
echo "[chezmoi] Ansible installation completed successfully!"
