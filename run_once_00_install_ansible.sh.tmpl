#!/bin/bash

set -euo pipefail

# Pre-flight check function for Ansible - Exit if Ansible is already installed and latest
check_ansible_installed_and_latest() {
    if command -v ansible &>/dev/null; then
        INSTALLED_VERSION=$(ansible --version | head -n1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        LATEST_VERSION=$(python3 -m pip index versions ansible 2>/dev/null | grep -oP 'Available versions:.*' | head -n1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n1)
        if [ -z "$LATEST_VERSION" ]; then
            # Fallback if pip index is not available, use pip show
            LATEST_VERSION=$(python3 -m pip install ansible==random 2>&1 | grep -oE 'from versions: [^)]*' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n1)
        fi
        if [ "$INSTALLED_VERSION" = "$LATEST_VERSION" ]; then
            echo "[chezmoi] Ansible is already installed and is the latest version ($INSTALLED_VERSION)."
            exit 0
        else
            echo "[chezmoi] Ansible is installed but not the latest version. Upgrading from $INSTALLED_VERSION to $LATEST_VERSION..."
        fi
    fi
}

# Function to check if Ansible exists post-installation and its version - Exit with error if not found
check_ansible_version() {
    if command -v ansible &>/dev/null; then
        echo "[chezmoi] Ansible is installed successfully."
        ANSIBLE_VERSION=$(ansible --version | head -n1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        echo "[chezmoi] Ansible version: $ANSIBLE_VERSION"
    else
        echo "[chezmoi] Ansible did not install properly! Please check the installation logs."
        exit 1
    fi
}

# Function to install latest Python and pip if not present, then install Ansible via pip --user
install_ansible_user() {
    echo "[chezmoi] Ensuring Python3 is installed..."
    if ! command -v python3 &>/dev/null; then
        echo "[chezmoi] Python3 not found. Please install Python3 manually and re-run this script."
        exit 1
    fi
    PYTHON=python3

    echo "[chezmoi] Ensuring pip is installed..."
    if ! $PYTHON -m pip --version &>/dev/null; then
        echo "[chezmoi] pip not found. Installing pip..."
        curl -sS https://bootstrap.pypa.io/get-pip.py | $PYTHON -
    fi

    echo "[chezmoi] Installing Ansible with pip (user install)..."
    $PYTHON -m pip install --user --upgrade pip
    $PYTHON -m pip install --user --upgrade ansible

    # Ensure $HOME/.local/bin is in PATH for this session
    export PATH="$HOME/.local/bin:$PATH"
    check_ansible_version
}

echo "[chezmoi] Prewarming sudo..."
sudo true
echo "[chezmoi] Checking if Ansible is already installed and latest..."
check_ansible_installed_and_latest
echo "[chezmoi] Ansible not found or not latest! Proceeding with user installation or upgrade..."
echo "[chezmoi] This may take a while, please be patient..."
install_ansible_user
echo "[chezmoi] Ansible installation completed successfully!"
